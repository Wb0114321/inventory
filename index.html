<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- QR Barcode Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      background: #0d1117;
      color: #fff;
      font-family: Arial;
      padding: 15px;
    }

    .box {
      background: #161b22;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0,255,255,0.1);
    }

    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      background: #21262d;
      color: white;
    }

    button {
      background: #238636;
      font-weight: bold;
    }

    #reader {
      width: 100%;
      display: none;
      margin-top: 10px;
    }

    .closeBtn {
      background: red;
      display: none;
    }
  </style>
</head>

<body>

<div class="box">
  <h2>ðŸ“¦ Stock Entry Form</h2>

  <label>Barcode</label>
  <input type="text" id="barcode" oninput="fetchItem()" placeholder="Scan or enter barcode">

  <button onclick="openScanner()">ðŸ“· Scan with Mobile Back Camera</button>

  <div id="reader"></div>
  <button class="closeBtn" id="closeScan" onclick="closeScanner()">Close Scanner</button>

  <label>Item Name</label>
  <input type="text" id="name" readonly>

  <label>Category</label>
  <input type="text" id="category" readonly>

  <label>PO Date</label>
  <input type="date" id="podate">

  <label>PO No</label>
  <input type="text" id="pono">

  <label>Invoice Date</label>
  <input type="date" id="invdate">

  <label>Invoice No</label>
  <input type="text" id="invno">

  <label>Store Issue Date</label>
  <input type="date" id="issuedate">

  <label>Unit</label>
  <select id="unit">
    <option value="">Select Unit</option>
    <option>Nos</option><option>Kg</option><option>Gm</option>
    <option>Litre</option><option>Ml</option><option>Box</option>
    <option>Pkt</option><option>Bag</option><option>Set</option>
    <option>Pair</option><option>Bundle</option><option>Meter</option>
    <option>Piece</option>
  </select>

  <label>Quantity</label>
  <input type="number" id="qty">

  <button onclick="submitForm()">Submit</button>
</div>

<script>
let html5QrcodeScanner;

// ===== OPEN SCANNER WITH BACK CAMERA =====
function openScanner() {
  document.getElementById("reader").style.display = "block";
  document.getElementById("closeScan").style.display = "block";

  html5QrcodeScanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    let backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

    html5QrcodeScanner.start(
      backCam.id,
      { fps: 10, qrbox: 250 },
      barcode => {
        document.getElementById("barcode").value = barcode;
        closeScanner();
        fetchItem();
        setTimeout(() => document.getElementById("podate").focus(), 200);
      }
    );
  });
}

function closeScanner() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop();
    html5QrcodeScanner.clear();
  }
  document.getElementById("reader").style.display = "none";
  document.getElementById("closeScan").style.display = "none";
}

// ===== AUTO FETCH ITEM =====
function fetchItem() {
  let code = document.getElementById("barcode").value.trim();
  if (!code) return;

  google.script.run.withSuccessHandler(data => {
    if (data) {
      document.getElementById("name").value = data.name;
      document.getElementById("category").value = data.category;
    }
  }).getItemDetails(code);
}

// ===== SUBMIT =====
function submitForm() {
  let obj = {
    barcode: barcode.value,
    name: name.value,
    category: category.value,
    podate: podate.value,
    pono: pono.value,
    invdate: invdate.value,
    invno: invno.value,
    issuedate: issuedate.value,
    unit: unit.value,
    qty: qty.value
  };

  google.script.run.withSuccessHandler(msg => {
    alert(msg);

    // RESET FORM
    document.querySelectorAll("input").forEach(i => i.value = "");
    document.getElementById("unit").value = "";

    barcode.focus();
  }).saveData(obj);
}
</script>

</body>
</html>
